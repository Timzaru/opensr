{"ts":1380566622166,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"$(document).ready(function() {\n    Phase = {\n        INSTRUCTION: 0,\n        TESTING: 1,\n        TERMINATION: 2\n    };\n\n    initializeInstructionPhase();\n    \n    $(document).keypress(function(event) {\n        if (phase !== Phase.TERMINATION) {\n            var keyPressed = event.keyCode ? event.keyCode : event.which;\n            var START_KEY_BIND = 32;\n            var LEFT_KEY_BINDS = [\n                test[0].fields.left_key_bind.toLowerCase().charCodeAt(0),\n                test[0].fields.left_key_bind.toUpperCase().charCodeAt(0)\n            ];\n            var RIGHT_KEY_BINDS = [\n                test[0].fields.right_key_bind.toLowerCase().charCodeAt(0),\n                test[0].fields.right_key_bind.toUpperCase().charCodeAt(0)\n            ];\n            if (keyPressed === START_KEY_BIND && phase === Phase.INSTRUCTION) {\n                initializeTestingPhase();\n            } else if ($.inArray(keyPressed, LEFT_KEY_BINDS.concat(RIGHT_KEY_BINDS)) >= 0 && phase === Phase.TESTING) {\n                var correctRightCategory = $.inArray(keyPressed, RIGHT_KEY_BINDS) >= 0 && $.inArray(stimulus.fields.category, getIds(rightCategories)) >= 0;\n                var correctLeftCategory = $.inArray(keyPressed, LEFT_KEY_BINDS) >= 0 && $.inArray(stimulus.fields.category, getIds(leftCategories)) >= 0;\n                if (correctRightCategory || correctLeftCategory) {\n                    handleCorrectAnswer();\n                    if (stimulusCount > block.fields.number_of_stimuli) {\n                        if (blocks.length > 0) {\n                            initializeInstructionPhase();\n                        } else {\n                            initializeTerminationPhase();\n                        }\n                    }\n                } else {\n                    handleIncorrectAnswer();\n                }\n            }\n        }\n    });\n});\n\nfunction handleBlock() {\n    for (var order = 1; order < 10; order++) {\n        var blockGroup = $.grep(blocks, function(n) {\n            return n.fields.order === order;\n        });\n        if (blockGroup !== null && blockGroup.length !== 0) {\n            var block = blockGroup[Math.floor(Math.random() * blockGroup.length)];\n            blocks = blocks.filter(function(item) {\n                return item.pk !== block.pk;\n            });\n            return block;\n        }\n    }\n}\n\nfunction handleStimulus(leftCategories, rightCategories) {\n    var categoryIds = getIds(leftCategories).concat(getIds(rightCategories));\n    var filteredStimuli = $.grep(stimuli, function(n) {\n        return $.inArray(n.fields.category, categoryIds) >= 0;\n    });\n    var stimulus = filteredStimuli[Math.floor(Math.random() * filteredStimuli.length)];\n    var html = (stimulus.model === \"portal.imagestimulus\") \n          ? '<img class=\"image-stimulus\" src=\"' + media_url + stimulus.fields.value + '\" alt=\"picture\" />'\n          : '<span class=\"text-stimulus\">' + stimulus.fields.value + \"</span>\";\n    $(\"#stimulus\").html(html);\n    return stimulus;\n}\n\nfunction handleCategory(block, categoryType) {\n    var filteredCategories = $.grep(categories, function(n) {\n        return n.pk === block.fields[\"primary_\" + categoryType + \"_category\"] || n.pk === block.fields[\"secondary_\" + categoryType + \"_category\"];\n    });\n    $(\"#primary-\" + categoryType + \"-category\").html(filteredCategories[0].fields.category_name).css(\"color\", filteredCategories[0].fields.color);\n    if (filteredCategories.length > 1) {\n        $(\"#secondary-\" + categoryType + \"-category\").html(filteredCategories[1].fields.category_name).css(\"color\", filteredCategories[1].fields.color);\n        $(\"#\" + categoryType + \"-separator\").show();\n    } else {\n        $(\"#\" + categoryType + \"-separator\").hide();\n    }\n    return filteredCategories;\n}\n\nfunction initializeTerminationPhase() {\n    phase = Phase.TERMINATION;\n    $(\"#testing-phase-container\").hide();\n    $(\"#termination-phase-container\").show();\n    data = {'test_status': true};\n    $.get(\"../record/test-status/\", data);\n}\n\nfunction initializeInstructionPhase() {\n    phase = Phase.INSTRUCTION;\n    block = handleBlock();\n    stimulusCount = 0;\n    $(\"#instructions\").html(block.fields.instructions);\n    $(\"#testing-phase-container\").hide();\n    $(\"#instruction-phase-container\").show();\n    $(\"#status\").css(\"visibility\", \"hidden\");\n}\n\nfunction initializeTestingPhase() {\n    phase = Phase.TESTING;\n    leftCategories = handleCategory(block, \"left\");\n    rightCategories = handleCategory(block, \"right\");\n    stimulus = handleStimulus(leftCategories, rightCategories);\n    previousStimulus = stimulus;\n    stimulusCount = 1;\n    startTime = new Date().getTime();\n    correct = true;\n    $(\"#instruction-phase-container\").hide();\n    $(\"#testing-phase-container\").show();\n}\n\nfunction handleCorrectAnswer() {\n    function record_trial(block, leftCategories, rightCategories, stimulus, latency, correct) {\n        data = {\n            \"block\": block.fields.block_name,\n            \"practice\": block.fields.practice,\n            \"primary_left_category\": leftCategories[0].fields.category_name,\n            \"secondary_left_category\": leftCategories.length > 1 ? leftCategories[1].fields.category_name : null,\n            \"primary_right_category\": rightCategories[0].fields.category_name,\n            \"secondary_right_category\": rightCategories.length > 1 ? rightCategories[1].fields.category_name : null,\n            \"stimulus\": stimulus.fields.value,\n            \"latency\": latency,\n            \"correct\": correct\n        };\n        $.get(\"../record/trial/\", data);\n    }\n\n    record_trial(block, leftCategories, rightCategories, stimulus, new Date().getTime() - startTime, correct);\n    startTime = new Date().getTime();\n    while (stimulus === previousStimulus) {\n         stimulus = handleStimulus(leftCategories, rightCategories);\n    }\n    previousStimulus = stimulus;\n    stimulusCount++;\n    $(\"#status\").css(\"visibility\", \"hidden\");\n}\n\nfunction handleIncorrectAnswer() {\n    correct = false;\n    $(\"#status\").css(\"visibility\", \"visible\");\n}\n\nfunction getIds(list) {\n    var ids = [];\n    $.each(list, function(index, value) {\n        ids.push(value.pk);\n    });\n    return ids;\n}"]],"start1":0,"start2":0,"length1":0,"length2":6165}]],"length":6165}
{"contributors":[],"silentsave":false,"ts":1380914310287,"patch":[[{"diffs":[[0," true};\n"],[1,"    alert();\n"],[0,"    $.ge"]],"start1":3950,"start2":3950,"length1":16,"length2":29}]],"length":6178,"saved":false}
{"ts":1380914351777,"patch":[[{"diffs":[[0,"e};\n"],[-1,"    alert();\n"],[0,"    "]],"start1":3954,"start2":3954,"length1":21,"length2":8}]],"length":6165,"saved":false}
